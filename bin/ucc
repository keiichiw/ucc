#!/bin/bash

BIN_DIR=`dirname "$0"`
CPP=cpp
CC=$BIN_DIR/cc
AS=$BIN_DIR/as
UCCLIB=$BIN_DIR/../lib/libucc.s

INCLUDE_DIR=.
OUTFILE=a.out

usage_exit() {
    echo "Usage: $0 [-s] [-o file] file" 1>&2
    exit 1
}

while getopts sSI:o:h OPT
do
    case $OPT in
        s|S)
            ASM_MODE=1
            ;;
        o)
            OUTFILE=$OPTARG;
            OFLAG=1
            ;;
        I)
            INCLUDE_DIR=$OPTARG
            ;;
        h)  usage_exit
            ;;
        \?) usage_exit
            ;;
    esac
done

shift $((OPTIND - 1))

FILEDIR=`dirname $1`
FILENAME=`basename $1`

# syntax check

gcc -I$INCLUDE_DIR -w -fsyntax-only $1 || exit 1

# preprocess

$CPP -I$INCLUDE_DIR -D__UCC__=1 $1 > /tmp/$FILENAME.x || exit 1

# compile

$CC /tmp/$FILENAME.x || exit 1

if [ $ASM_MODE ]
then
    if [ $OFLAG ]
    then
        cp /tmp/$FILENAME.x.s $OUTFILE
    else
        cp /tmp/$FILENAME.x.s $FILEDIR/${FILENAME%.*}.s
    fi
    exit 0
fi

# assemble

$AS /tmp/$FILENAME.x.s -l $UCCLIB -o $OUTFILE || exit 1
